<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POTATO RPG</title>
  
  <!-- 1. ìŠ¤íƒ€ì¼ ì„¤ì • -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #0f172a; color: white; margin: 0; padding: 0; }
    #loading-screen { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: #0f172a; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; z-index: 9999;
    }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <!-- 2. vConsole (ë””ë²„ê¹…ìš©) -->
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    try { var vConsole = new VConsole(); } catch(e) {}
  </script>

  <!-- 3. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>

  <div id="loading-screen">
      <div class="loader"></div>
      <h2 style="color: #60a5fa;">ë¡œë”© ì¤‘...</h2>
      <div id="loading-msg" style="margin-top:10px; color:#94a3b8; font-size:12px;">ë°ì´í„° ì—°ê²° ì‹œë„ ì¤‘...</div>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // =================================================================================
    // [í•„ìˆ˜] êµ¬ê¸€ ì•± ìŠ¤í¬ë¦½íŠ¸(GAS) ì›¹ ì•± URLì„ ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— ë„£ì–´ì£¼ì„¸ìš”.
    // =================================================================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvL_qsVVvaS45572soDLu8byVX70XA4FCKf8jPcXTz8pA6LJvdBWCZo4Y7zl07Dn45og/exec"; 
    
    // --- ê²Œì„ ë°¸ëŸ°ìŠ¤ ì„¤ì • ---
    const RARITY_RATES = { Myth: 0.0001, Legend: 0.01, Unique: 0.1, Rare: 0.2, Common: 0.3 };
    const RARITY_COLORS = { Common: 'text-gray-500', Rare: 'text-blue-500', Unique: 'text-purple-500', Legend: 'text-orange-500', Myth: 'text-red-600 font-bold animate-pulse' };
    const ITEM_RANGES = { Common: { min: 1, max: 10, price: 50 }, Rare: { min: 10, max: 20, price: 200 }, Unique: { min: 20, max: 30, price: 1000 }, Legend: { min: 30, max: 50, price: 5000 }, Myth: { min: 50, max: 100, price: 10000 } };
    const ENHANCE_RATES = [0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1, 0.1];

    // ë¹„ìƒìš© ë°ëª¨ ë°ì´í„° (ì—°ê²° ì‹¤íŒ¨ ì‹œì—ë§Œ ì‚¬ìš©)
    const MOCK_QUESTIONS = [
      { id: 9991, subject: 'ì‹œìŠ¤í…œ', question: "ë°ì´í„° ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", options: ['ìƒˆë¡œê³ ì¹¨', 'ê´€ë¦¬ì ë¬¸ì˜'], answer: 0 },
      { id: 9992, subject: 'ìˆ˜í•™', question: "1 + 1 = ?", options: ['1', '2', '3', '4'], answer: 1 },
      { id: 9993, subject: 'ë³´ìŠ¤', question: "ë³´ìŠ¤ ì „ìš© ë¬¸ì œ í…ŒìŠ¤íŠ¸: ì‚¬ê³¼ì˜ ìƒ‰ê¹”ì€?", options: ['ë¹¨ê°•', 'íŒŒë‘'], answer: 0 },
    ];

    // --- Firebase ì„¤ì • ---
    const firebaseConfig = {
      apiKey: "AIzaSyDOzfbbafGWHHC2QbGXTsp67bop74O5RIM",
      authDomain: "potatp-rpg.firebaseapp.com",
      projectId: "potatp-rpg",
      storageBucket: "potatp-rpg.firebasestorage.app",
      messagingSenderId: "665096612054",
      appId: "1:665096612054:web:2252bc6f22adf1f1cf8177"
    };

    let isFirebaseOk = false;
    try {
        if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            isFirebaseOk = true;
        }
    } catch(e) { console.error("Firebase Init Error", e); }

    const db = isFirebaseOk ? firebase.firestore() : null;
    const auth = isFirebaseOk ? firebase.auth() : null;
    const appId = 'educational-rpg-gsheet';

    // --- ì•„ì´ì½˜ ---
    const Icons = {
      Sword: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>,
      Shield: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
      Heart: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
      Coins: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg>,
      Skull: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>,
      Hammer: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V2.46V2a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v2.46c0 .85-.33 1.65-.93 2.25L11.7 10.91"/></svg>,
      LogOut: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
      BookOpen: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
      Lightbulb: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-3.3-2.7-6-6-6s-6 2.7-6 6c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
      Menu: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
      RefreshCw: ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
    };

    // ì—ëŸ¬ ë°©ì§€ìš© ê²½ê³„ ì»´í¬ë„ŒíŠ¸
    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, errorInfo) { console.error("React Error:", error, errorInfo); }
      render() {
        if (this.state.hasError) {
          return (
            <div className="p-8 text-center text-white bg-red-900 h-screen flex flex-col items-center justify-center">
              <h1 className="text-2xl font-bold mb-4">ì•± ì˜¤ë¥˜ ë°œìƒ</h1>
              <pre className="bg-black p-4 rounded text-left text-xs overflow-auto max-w-full">{this.state.error && this.state.error.toString()}</pre>
              <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="mt-6 bg-white text-black px-4 py-2 rounded font-bold">ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨</button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    function App() {
      const [loading, setLoading] = useState(true);
      const [errorMsg, setErrorMsg] = useState(null);
      const [view, setView] = useState('login');
      const [loginName, setLoginName] = useState('');
      const [loginPw, setLoginPw] = useState('');
      
      const defaultPlayer = {
        name: 'ëª¨í—˜ê°€', level: 1, exp: 0, maxExp: 100, hp: 100, maxHp: 100, gold: 0, baseAtk: 10, 
        equippedWeapon: null, inventory: [], solved: [] 
      };

      const [player, setPlayer] = useState(defaultPlayer);
      const [monster, setMonster] = useState(null);
      const [currentSubject, setCurrentSubject] = useState('ìˆ˜í•™');
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [battleLog, setBattleLog] = useState([]);
      const [bossStreak, setBossStreak] = useState(0);
      const [isRespawning, setIsRespawning] = useState(false);
      const [questions, setQuestions] = useState([]);
      const [message, setMessage] = useState(null);
      const [accountId, setAccountId] = useState(null);

      useEffect(() => {
        let isMounted = true;
        const savedName = localStorage.getItem('last_login_name');
        if (savedName) setLoginName(savedName);

        const safetyTimer = setTimeout(() => {
            if (isMounted) {
                console.warn("Loading timeout");
                setErrorMsg("ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (10ì´ˆ)");
            }
        }, 10000);

        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) {
             clearTimeout(safetyTimer);
             if(isMounted) {
                 setErrorMsg("URL ì„¤ì • ì˜¤ë¥˜: index.html íŒŒì¼ì˜ GOOGLE_SCRIPT_URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                 setQuestions(MOCK_QUESTIONS);
                 setLoading(false);
             }
             return;
        }

        fetch(GOOGLE_SCRIPT_URL)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                return res.json();
            })
            .then(data => {
                if(!isMounted) return;
                clearTimeout(safetyTimer);
                
                if (Array.isArray(data) && data.length > 0) {
                    const formatted = data.map((item, index) => ({
                        id: index, 
                        subject: item.subject,
                        question: item.question,
                        options: item.options,
                        answer: parseInt(item.answer) - 1
                    }));
                    setQuestions(formatted);
                    setErrorMsg(null);
                } else {
                    throw new Error("ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                setLoading(false);
            })
            .catch(err => {
                if(!isMounted) return;
                clearTimeout(safetyTimer);
                console.error("Fetch Error:", err);
                setErrorMsg(`ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`);
                setQuestions(MOCK_QUESTIONS);
                setLoading(false);
            });

        if(auth) auth.signInAnonymously().catch(console.warn);

        return () => { isMounted = false; clearTimeout(safetyTimer); };
      }, []);

      // ë¡œë”© í™”ë©´ ì œê±°
      useEffect(() => {
          if (!loading) {
              const loader = document.getElementById('loading-screen');
              if(loader) loader.style.display = 'none';
          }
      }, [loading]);

      const showMessage = (text, type) => {
        setMessage({ text, type });
        setTimeout(() => setMessage(null), 3000);
      };

      const handleLogin = async () => {
        if (!loginName.trim() || !loginPw.trim()) return alert("ì…ë ¥ í•„ìš”");
        setLoading(true);
        const customId = `${loginName.trim()}_${loginPw.trim()}`;
        setAccountId(customId);
        localStorage.setItem('last_login_name', loginName.trim());

        const safeSetPlayer = (data) => {
            const mergedPlayer = { ...defaultPlayer, ...data };
            if (!mergedPlayer.inventory) mergedPlayer.inventory = [];
            if (!mergedPlayer.solved) mergedPlayer.solved = []; 
            setPlayer(mergedPlayer);
            return mergedPlayer;
        };

        if (!db) { 
             const localData = localStorage.getItem('rpg_save_' + customId);
             try { 
                 if (localData) {
                    const p = safeSetPlayer(JSON.parse(localData));
                    showMessage(`(ë¡œì»¬) ${p.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
                 } else {
                    safeSetPlayer({name: loginName.trim()});
                    showMessage(`(ë¡œì»¬) ìƒˆë¡œìš´ ëª¨í—˜ ì‹œì‘!`, 'success');
                 }
             } catch(e) { safeSetPlayer({name: loginName.trim()}); }
             
             setView('lobby');
             setLoading(false);
             return;
        }

        try {
            const docRef = db.collection('artifacts').doc(appId).collection('accounts').doc(customId);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const p = safeSetPlayer(docSnap.data());
                showMessage(`${p.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
            } else {
                const newPlayer = { ...defaultPlayer, name: loginName.trim() };
                setPlayer(newPlayer);
                await docRef.set(newPlayer);
                showMessage(`ìƒˆë¡œìš´ ëª¨í—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.`, 'success');
            }
            setView('lobby');
        } catch(e) {
            console.error(e);
            alert("ë¡œê·¸ì¸ ì˜¤ë¥˜ (ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸)");
        }
        setLoading(false);
      };

      const savePlayerData = async (newData) => {
        setPlayer(newData);
        if (!accountId) return;
        localStorage.setItem('rpg_save_' + accountId, JSON.stringify(newData));
        if (db) {
            try {
                await db.collection('artifacts').doc(appId).collection('accounts').doc(accountId).set(newData);
            } catch (e) { console.error(e); }
        }
      };

      const getTotalAtk = (p = player) => {
        let atk = p.baseAtk;
        if (p.equippedWeapon) atk += p.equippedWeapon.atk;
        return atk;
      };

      const spawnMonster = (isBoss = false, targetPlayer = player, specificSubject = null) => {
        // [ì¶”ê°€] ë³´ìŠ¤ ì…ì¥ ë ˆë²¨ ì œí•œ ì²´í¬
        if (isBoss && targetPlayer.level < 10) {
            showMessage("ë³´ìŠ¤ ë ˆì´ë“œëŠ” ë ˆë²¨ 10ë¶€í„° ì…ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤!", "error");
            return;
        }

        setIsRespawning(false);
        if (isBoss) {
          setMonster({ name: 'í˜¼ëˆì˜ ì§€ë°°ì (BOSS)', level: 99, hp: 10000, maxHp: 10000, atk: 999, image: 'ğŸ²' });
          setBossStreak(0);
        } else {
          const level = targetPlayer.level;
          const hp = level * (Math.floor(Math.random() * 6) + 10) + 10;
          const atk = level * 2 + 5;
          const types = ['ìŠ¬ë¼ì„', 'ê³ ë¸”ë¦°', 'ëŠ‘ëŒ€', 'ì˜¤í¬', 'ê³¨ë ˜', 'ë¨¸ì‰¬ë§˜'];
          const emojis = ['ğŸ’§', 'ğŸ‘º', 'ğŸº', 'ğŸ‘¹', 'ğŸ—¿', 'ğŸ„'];
          const idx = Math.floor(Math.random() * types.length);
          setMonster({ name: `Lv.${level} ${types[idx]}`, level, hp, maxHp: hp, atk, image: emojis[idx] });
        }
        
        // [ì¤‘ìš”] ëª¬ìŠ¤í„° ìƒì„± ì‹œì—ë„ ìµœì‹  solved ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¬¸ì œ ì„ íƒ
        pickQuestion(isBoss, specificSubject, targetPlayer.solved);
      };

      // --- [í•µì‹¬] ìˆœì°¨ ì¶œì œ + ë‹¤ í’€ë©´ ë¦¬ì…‹ ---
      const pickQuestion = (isBoss = false, specificSubject = null, solvedOverride = null) => {
        // ë³´ìŠ¤ì „ì€ ì˜¤ì§ 'ë³´ìŠ¤' ê³¼ëª© ë¬¸ì œë§Œ, ì•„ë‹ˆë©´ ì„ íƒëœ ê³¼ëª©
        const subject = isBoss ? 'ë³´ìŠ¤' : (specificSubject || currentSubject);
        const safeQuestions = questions.length > 0 ? questions : MOCK_QUESTIONS;
        
        let subjectQuestions = safeQuestions.filter(q => q.subject === subject);
        
        // ë³´ìŠ¤ ë¬¸ì œ ì—†ìœ¼ë©´ ëœë¤ ì¶œì œ (ë¹„ìƒìš©)
        if (isBoss && subjectQuestions.length === 0) {
            if(safeQuestions.some(q => q.subject === 'ë³´ìŠ¤')) {
                // ë³´ìŠ¤ ë¬¸ì œê°€ ìˆëŠ”ë° ë¡œë“œ ì•ˆëœ ê²½ìš° ì œì™¸
            } else {
                // ì§„ì§œ ë³´ìŠ¤ ë¬¸ì œê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë¹„ìƒìš©ìœ¼ë¡œ ì „ì²´ì—ì„œ
                 subjectQuestions = safeQuestions;
            }
        }
        if (subjectQuestions.length === 0) subjectQuestions = safeQuestions;

        const solvedList = solvedOverride || player.solved || [];
        
        // [ìˆœì°¨] ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ ì¤‘ ê°€ì¥ ìœ„ì— ìˆëŠ”(IDê°€ ì‘ì€) ê²ƒ ì°¾ê¸°
        let nextQuestion = subjectQuestions.find(q => !solvedList.includes(q.id));

        // ë‹¤ í’€ì—ˆìœ¼ë©´ ë¦¬ì…‹
        if (!nextQuestion) {
            if (!isBoss) showMessage(`${subject} ê³¼ëª© ì™„ì „ ì •ë³µ! (ì´ˆê¸°í™”)`, 'info');
            
            // í•´ë‹¹ ê³¼ëª©ì˜ IDë§Œ solved ëª©ë¡ì—ì„œ ì œê±°
            const subjectIds = subjectQuestions.map(q => q.id);
            const resetSolvedList = solvedList.filter(id => !subjectIds.includes(id));
            
            const newPlayer = { ...player, solved: resetSolvedList };
            setPlayer(newPlayer);
            savePlayerData(newPlayer);

            // ë‹¤ì‹œ ì²« ë²ˆì§¸ ë¬¸ì œ
            nextQuestion = subjectQuestions[0];
        }

        setCurrentQuestion(nextQuestion || safeQuestions[0]);
      };

      const tryDropItem = (playerToUpdate) => {
        const roll = Math.random();
        let rarity = null;
        if (roll < RARITY_RATES.Myth) rarity = 'Myth';
        else if (roll < RARITY_RATES.Legend + RARITY_RATES.Myth) rarity = 'Legend';
        else if (roll < RARITY_RATES.Unique + RARITY_RATES.Legend) rarity = 'Unique';
        else if (roll < RARITY_RATES.Rare + RARITY_RATES.Unique) rarity = 'Rare';
        else if (roll < RARITY_RATES.Common + RARITY_RATES.Rare) rarity = 'Common';
        
        if (rarity) {
          const range = ITEM_RANGES[rarity];
          const atk = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
          const newItem = { id: Date.now() + Math.random().toString(), name: `${rarity} ê²€`, rarity, atk, value: range.price, enhanceLevel: 0, type: 'weapon' };
          playerToUpdate.inventory.push(newItem);
          showMessage(`[${rarity}] ì•„ì´í…œ íšë“!`, 'success');
        }
      };

      const dropBossReward = (playerToUpdate) => {
        const rarity = Math.random() < 0.1 ? 'Myth' : 'Legend';
        const range = ITEM_RANGES[rarity];
        const atk = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
        const newItem = { id: Date.now().toString(), name: `ë³´ìŠ¤ ìŠ¬ë ˆì´ì–´ (${rarity})`, rarity, atk, value: range.price * 2, enhanceLevel: 0, type: 'weapon' };
        playerToUpdate.inventory.push(newItem);
        showMessage(`ë³´ìŠ¤ ë³´ìƒ: ${newItem.name} íšë“!`, 'success');
      };

      const handleAnswer = (idx) => {
        if (!monster || !currentQuestion || isRespawning) return;
        const isCorrect = idx === currentQuestion.answer;
        const newPlayer = { ...player };
        newPlayer.inventory = [...(player.inventory || [])];
        newPlayer.solved = [...(player.solved || [])]; 
        let logMsg = '';

        if (isCorrect) {
          // [ì¤‘ìš”] ì •ë‹µ ì‹œ í‘¼ ë¬¸ì œ ëª©ë¡ì— ID ì¶”ê°€
          if (currentQuestion.id !== undefined && !newPlayer.solved.includes(currentQuestion.id)) {
              newPlayer.solved.push(currentQuestion.id);
          }

          if (view === 'boss') {
            const newStreak = bossStreak + 1;
            setBossStreak(newStreak);
            logMsg = `ì •ë‹µ! (${newStreak}/10)`;
            if (newStreak >= 10) {
              logMsg = 'ë³´ìŠ¤ í† ë²Œ ì„±ê³µ!';
              dropBossReward(newPlayer);
              setMonster(null);
              setView('lobby');
            } else {
              pickQuestion(true, null, newPlayer.solved); 
            }
          } else {
            const isCrit = Math.random() < 0.2;
            let dmg = getTotalAtk(newPlayer);
            if (isCrit) { dmg *= 2; logMsg = `í¬ë¦¬í‹°ì»¬! ${dmg} í”¼í•´!`; } 
            else { logMsg = `ì •ë‹µ! ${dmg} í”¼í•´.`; }

            const newMonsterHp = monster.hp - dmg;
            tryDropItem(newPlayer);

            if (newMonsterHp <= 0) {
              const expGain = 20 + (newPlayer.level * 10);
              const goldGain = Math.floor(Math.random() * 50) + 10;
              newPlayer.exp += expGain;
              newPlayer.gold += goldGain;
              logMsg = `ì²˜ì¹˜! +${expGain}XP +${goldGain}G`;

              if (newPlayer.exp >= newPlayer.maxExp) {
                newPlayer.level += 1;
                newPlayer.exp -= newPlayer.maxExp;
                newPlayer.maxExp = Math.floor(newPlayer.maxExp * 1.2);
                newPlayer.maxHp += 20;
                newPlayer.hp = newPlayer.maxHp;
                newPlayer.baseAtk += 2;
                logMsg += ' âœ¨ ë ˆë²¨ ì—…!';
              }
              setMonster(null);
              setIsRespawning(true);
              setTimeout(() => spawnMonster(false, newPlayer, null), 1500);
            } else {
              setMonster({ ...monster, hp: newMonsterHp });
              // ëª¬ìŠ¤í„°ê°€ ì‚´ì•„ìˆì–´ë„ ë‹¤ìŒ ë¬¸ì œë¡œ (ìˆœì°¨ ì¶œì œ)
              pickQuestion(false, null, newPlayer.solved); 
            }
          }
        } else {
          const dmg = Math.floor(monster.atk * 0.8);
          newPlayer.hp -= dmg;
          logMsg = `ì˜¤ë‹µ... ${dmg} í”¼í•´.`;
          if (newPlayer.hp <= 0) {
            newPlayer.hp = newPlayer.maxHp;
            const lostGold = Math.floor(newPlayer.gold * 0.5);
            newPlayer.gold -= lostGold;
            logMsg = `ì‚¬ë§... ê³¨ë“œ ì ˆë°˜ ì†Œì‹¤.`;
            setMonster(null);
            setView('lobby');
          } else {
            // ì˜¤ë‹µ ì‹œ ë¬¸ì œ ìœ ì§€
            pickQuestion(view === 'boss', null, newPlayer.solved);
          }
        }
        setBattleLog(prev => [logMsg, ...prev].slice(0, 5));
        savePlayerData(newPlayer);
      };

      const sellItem = (itemId) => {
        const idx = player.inventory.findIndex(i => i.id === itemId);
        if (idx === -1) return;
        const newPlayer = { ...player };
        newPlayer.inventory = [...player.inventory];
        const item = newPlayer.inventory[idx];
        if (newPlayer.equippedWeapon?.id === itemId) newPlayer.equippedWeapon = null;
        newPlayer.gold += item.value;
        newPlayer.inventory.splice(idx, 1);
        savePlayerData(newPlayer);
        showMessage(`íŒë§¤ ì™„ë£Œ +${item.value}G`, 'success');
      };

      const equipItem = (item) => {
        const newPlayer = { ...player, equippedWeapon: item };
        savePlayerData(newPlayer);
        showMessage('ì¥ì°©í–ˆìŠµë‹ˆë‹¤.', 'success');
      };

      const enhanceItem = (item) => {
        const cost = 100 + (item.enhanceLevel * 100);
        if (player.gold < cost) return showMessage('ê³¨ë“œ ë¶€ì¡±!', 'error');
        if (item.enhanceLevel >= 10) return showMessage('ìµœëŒ€ ê°•í™” ìƒíƒœ', 'info');
        
        const newPlayer = { ...player };
        newPlayer.inventory = [...player.inventory];
        newPlayer.gold -= cost;
        const target = newPlayer.inventory.find(i => i.id === item.id);
        if (!target) return;
        
        if (Math.random() < ENHANCE_RATES[target.enhanceLevel]) {
           const bonus = target.enhanceLevel + 1;
           target.enhanceLevel += 1;
           target.atk += bonus;
           showMessage(`ê°•í™” ì„±ê³µ! +${target.enhanceLevel}`, 'success');
        } else {
           showMessage('ê°•í™” ì‹¤íŒ¨...', 'error');
        }
        if (newPlayer.equippedWeapon?.id === target.id) newPlayer.equippedWeapon = target;
        savePlayerData(newPlayer);
      };

      const renderInventory = (isEnhance) => {
         const inv = player.inventory || [];
         return (
         <div className="space-y-3">
            {inv.length === 0 ? <div className="text-center text-gray-500 py-10">ê°€ë°©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div> :
            inv.map(item => (
                <div key={item.id} className="bg-slate-700/50 p-2 rounded flex justify-between items-center border border-slate-600">
                    <div>
                        <div className={`font-bold text-sm ${RARITY_COLORS[item.rarity]}`}>
                            {item.name} {item.enhanceLevel > 0 && `+${item.enhanceLevel}`}
                            {player.equippedWeapon?.id === item.id && <span className="ml-2 text-[10px] bg-blue-600 text-white px-1 rounded align-middle">E</span>}
                        </div>
                        <div className="text-[10px] text-gray-400">ATK {item.atk} | {item.value}G</div>
                    </div>
                    <div className="flex gap-1">
                        {!isEnhance ? (
                            <>
                            <button onClick={() => equipItem(item)} className="bg-blue-700 px-2 py-1 rounded text-[10px] hover:bg-blue-600 text-white">ì¥ì°©</button>
                            <button onClick={() => sellItem(item.id)} className="bg-red-900/50 px-2 py-1 rounded text-[10px] hover:bg-red-800 text-red-200">íŒë§¤</button>
                            </>
                        ) : (
                            <button onClick={() => enhanceItem(item)} className="bg-yellow-700 px-2 py-1 rounded text-[10px] hover:bg-yellow-600 flex items-center gap-1 text-white">
                                <Icons.Hammer size={10}/> {100 + item.enhanceLevel * 100}G
                            </button>
                        )}
                    </div>
                </div>
            ))}
         </div>
         );
      };

      if (loading) return null;

      if (view === 'login') {
        return (
          <div className="flex flex-col h-screen items-center justify-center bg-slate-900 text-white p-4">
             <h1 className="text-4xl font-bold mb-8 text-blue-400 text-center">ğŸ“˜ POTATO RPG</h1>
             <div className="bg-slate-800 p-8 rounded-lg shadow-lg w-full max-w-md border border-slate-700">
                {errorMsg && (
                    <div className="bg-red-900/50 border border-red-500 text-red-200 p-3 rounded mb-4 text-xs">
                        âš ï¸ {errorMsg}
                    </div>
                )}
                
                <p className="text-center text-gray-300 mb-4 text-sm">ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì–¸ì œë“  ì´ì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div className="space-y-3">
                    <input type="text" placeholder="ì´ë¦„ (ì˜ˆ: ì§€ë¯¼)" className="w-full p-3 bg-slate-700 rounded border border-slate-600 text-white" onChange={(e) => setLoginName(e.target.value)} value={loginName} />
                    <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì 4ìë¦¬ ì¶”ì²œ)" className="w-full p-3 bg-slate-700 rounded border border-slate-600 text-white" onChange={(e) => setLoginPw(e.target.value)} value={loginPw} />
                    <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition shadow-lg">ê²Œì„ ì‹œì‘ / ì´ì–´í•˜ê¸°</button>
                </div>
                <div className="mt-6 text-xs text-gray-500 text-center"><p>ë°ì´í„° ì €ì¥: {db ? <span className="text-green-400">ì„œë²„(Firebase)</span> : <span className="text-yellow-400">ë¡œì»¬(ë‚´ê¸°ê¸°)</span>}</p></div>
             </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen bg-slate-900 text-white overflow-hidden w-full max-w-7xl mx-auto shadow-2xl relative">
          <div className="bg-slate-800 p-3 flex justify-between items-center border-b border-slate-700 z-10 shrink-0">
             <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold shadow-md">{player.level}</div>
                <div>
                   <div className="font-bold text-sm flex items-center gap-2">{player.name} <span className="text-xs font-normal text-gray-400 bg-slate-900 px-2 rounded-full">{player.equippedWeapon ? player.equippedWeapon.name : 'ë§¨ì†'}</span></div>
                   <div className="w-32 h-2 bg-slate-700 rounded-full overflow-hidden mt-1"><div className="h-full bg-yellow-400" style={{ width: `${(player.exp / player.maxExp) * 100}%` }}></div></div>
                </div>
             </div>
             <div className="flex gap-4 text-sm font-semibold">
                <div className="flex flex-col items-end">
                   <div className="flex items-center text-red-400"><Icons.Heart size={14} className="mr-1"/> {player.hp}/{player.maxHp}</div>
                   <div className="flex items-center text-yellow-400"><Icons.Coins size={14} className="mr-1"/> {player.gold} G</div>
                </div>
                <div className="flex items-center text-blue-300"><Icons.Sword size={14} className="mr-1"/> ATK {getTotalAtk()}</div>
             </div>
          </div>

          <div className="flex flex-1 overflow-hidden relative">
            <div className="flex-1 flex flex-col relative overflow-y-auto bg-slate-900">
               {message && <div className={`absolute top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg z-50 animate-bounce text-sm font-bold ${message.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>{message.text}</div>}
               
               {view === 'lobby' && (
                 <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 content-center max-w-4xl mx-auto w-full">
                    <div className="col-span-1 md:col-span-2 text-center mb-6">
                        <h2 className="text-3xl font-bold text-blue-300 mb-2">ëª¨í—˜ ì¤€ë¹„</h2>
                        <div className="text-sm text-gray-400 mb-2">ë¬¸ì œ ë°ì´í„°: {questions.length}ê°œ ë¡œë“œë¨</div>
                    </div>
                    {['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ìƒì‹'].map(subj => (
                        <button key={subj} onClick={() => { setCurrentSubject(subj); setView('battle'); spawnMonster(false, player, subj); }}
                            className="bg-slate-800 hover:bg-slate-700 p-6 rounded-xl border border-slate-600 flex flex-col items-center gap-3 transition transform hover:scale-105 shadow-lg group">
                            {subj === 'ìƒì‹' ? <Icons.Lightbulb size={40} className="text-yellow-400 group-hover:text-yellow-200" /> : <Icons.BookOpen size={40} className="text-blue-400 group-hover:text-blue-300" />}
                            <span className="font-bold text-xl">{subj}ì˜ ìˆ²</span>
                        </button>
                    ))}
                    <button onClick={() => { setView('boss'); spawnMonster(true); }} className="col-span-1 md:col-span-2 bg-gradient-to-r from-red-900/80 to-slate-900 p-6 rounded-xl border border-red-600 flex flex-row items-center justify-center gap-4 transition mt-4 hover:brightness-110">
                        <Icons.Skull size={48} className="text-red-500 animate-pulse" />
                        <div className="text-left"><span className="font-bold text-2xl text-red-200 block">ë³´ìŠ¤ ë ˆì´ë“œ</span><span className="text-sm text-red-300">ëœë¤ ê³¼ëª© 10ì—°ì† ì •ë‹µ ë„ì „!</span></div>
                    </button>
                 </div>
               )}

               {(view === 'battle' || view === 'boss') && (
                 <div className="flex flex-col h-full p-4 max-w-3xl mx-auto w-full">
                    <div className="flex-1 flex flex-col items-center justify-center relative mb-4 min-h-[200px]">
                        <div className="absolute inset-0 bg-slate-800/30 rounded-xl pointer-events-none"></div>
                        {monster ? (
                            <div className="z-10 text-center">
                                <div className="text-8xl mb-4 filter drop-shadow-2xl animate-bounce-slow">{monster.image}</div>
                                <div className="text-2xl font-bold text-red-300 mb-1">{monster.name}</div>
                                {view === 'boss' && <div className="text-yellow-400 font-bold mb-2">Streak: {bossStreak} / 10</div>}
                                <div className="w-64 h-5 bg-slate-700 rounded-full overflow-hidden mx-auto border border-slate-600 shadow-inner"><div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${(monster.hp / monster.maxHp) * 100}%` }}></div></div>
                                <div className="text-sm mt-1 text-gray-400 font-mono">{monster.hp} / {monster.maxHp} HP</div>
                            </div>
                        ) : (
                            <div className="text-center z-10 text-gray-400 flex flex-col items-center gap-2"><Icons.RefreshCw className="animate-spin text-blue-400" size={32}/><span>{isRespawning ? "ë‹¤ìŒ ëª¬ìŠ¤í„° ì°¾ëŠ” ì¤‘..." : "íƒìƒ‰ ì¤‘..."}</span></div>
                        )}
                    </div>
                    <div className="h-20 overflow-y-auto bg-black/40 rounded p-3 text-sm text-gray-300 mb-4 font-mono shadow-inner border border-slate-700/50">
                        {battleLog.map((log, i) => <div key={i} className="mb-1 border-b border-white/5 pb-1">{log}</div>)}
                    </div>
                    {currentQuestion && monster && (
                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 shadow-xl">
                            <span className="text-xs bg-blue-900 text-blue-200 px-3 py-1 rounded-full font-bold mb-3 inline-block">{currentQuestion.subject}</span>
                            <div className="text-xl font-bold mb-6 leading-relaxed">
                                {currentQuestion.question.startsWith('http') ? (
                                    <img src={currentQuestion.question} alt="ë¬¸ì œ ì´ë¯¸ì§€" className="max-w-full h-auto rounded" />
                                ) : (
                                    currentQuestion.question
                                )}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {currentQuestion.options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(idx)} className="bg-slate-700 hover:bg-blue-600 p-4 rounded-lg text-left transition duration-200 border border-slate-600 hover:border-blue-400 font-medium">
                                        <span className="text-blue-300 mr-2 font-bold">{idx + 1}.</span> 
                                        {opt.startsWith('http') ? <img src={opt} alt={`ë³´ê¸° ${idx+1}`} className="inline-block max-h-20 rounded" /> : opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    <button onClick={() => { setView('lobby'); setMonster(null); }} className="mt-6 text-gray-500 hover:text-white flex items-center justify-center gap-2 py-2 w-full md:w-auto mx-auto"><Icons.LogOut size={16}/> ë„ë§ê°€ê¸°</button>
                 </div>
               )}

               {(view === 'inventory' || view === 'enhance') && (
                   <div className="p-4 h-full overflow-y-auto md:hidden">
                       <h2 className="text-xl font-bold mb-4 flex items-center gap-2 pb-2 border-b border-slate-700">{view === 'inventory' ? 'ì¸ë²¤í† ë¦¬' : 'ëŒ€ì¥ê°„'}</h2>
                       {renderInventory(view === 'enhance')}
                   </div>
               )}
            </div>

            <div className="hidden md:flex w-80 bg-slate-800 border-l border-slate-700 flex-col shrink-0">
               <div className="flex text-sm font-bold border-b border-slate-700">
                  <button className={`flex-1 p-3 flex items-center justify-center gap-2 ${view === 'enhance' ? 'bg-slate-700 text-gray-400' : 'bg-slate-800 text-blue-400'}`} onClick={() => view === 'enhance' ? setView('lobby') : null}><Icons.Sword size={16}/> ì¥ë¹„</button>
                  <button className={`flex-1 p-3 flex items-center justify-center gap-2 ${view === 'enhance' ? 'bg-slate-800 text-yellow-400' : 'bg-slate-700 text-gray-400'}`} onClick={() => setView('enhance')}><Icons.Hammer size={16}/> ê°•í™”</button>
               </div>
               <div className="flex-1 overflow-y-auto p-3">{renderInventory(view === 'enhance')}</div>
            </div>
          </div>

          <div className="md:hidden bg-slate-800 p-2 flex justify-around border-t border-slate-700 z-10 shrink-0">
             <button onClick={() => setView('lobby')} className={`p-2 rounded flex flex-col items-center gap-1 ${view === 'lobby' ? 'text-blue-400' : 'text-gray-400'}`}><Icons.Menu size={20}/><span className="text-[10px]">ë¡œë¹„</span></button>
             <button onClick={() => setView('inventory')} className={`p-2 rounded flex flex-col items-center gap-1 ${view === 'inventory' ? 'text-blue-400' : 'text-gray-400'}`}><Icons.Sword size={20}/><span className="text-[10px]">ê°€ë°©</span></button>
             <button onClick={() => setView('enhance')} className={`p-2 rounded flex flex-col items-center gap-1 ${view === 'enhance' ? 'text-blue-400' : 'text-gray-400'}`}><Icons.Hammer size={20}/><span className="text-[10px]">ê°•í™”</span></button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    // ErrorBoundaryë¡œ App ê°ì‹¸ê¸°
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>

